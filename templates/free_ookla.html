<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <title>Free Ookla</title>

</head>

<body>
    <h1>hi</h1>
    <iframe id = "ookla" width="100%" height="650px" frameborder="0" src="http://joeyrose.speedtestcustom.com" style = "visibility: hidden;" onload = "show_iframe(event)"></iframe>
    <script>
        function show_iframe(event) {
            console.log("revealing iframe");
            console.log("element is " + event.target.style);
            event.target.style.removeProperty("visibility");
        }

        class ClassWatcher {

            constructor(targetNode, classToWatch, classAddedCallback, classRemovedCallback) {
                this.targetNode = targetNode
                this.classToWatch = classToWatch
                this.classAddedCallback = classAddedCallback
                this.classRemovedCallback = classRemovedCallback
                this.observer = null
                this.lastClassState = targetNode.classList.contains(this.classToWatch)

                this.init()
            }

            init() {
                this.observer = new MutationObserver(this.mutationCallback)
                this.observe()
            }

            observe() {
                this.observer.observe(this.targetNode, { attributes: true })
            }

            disconnect() {
                this.observer.disconnect()
            }

            mutationCallback = mutationsList => {
                for(let mutation of mutationsList) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        let currentClassState = mutation.target.classList.contains(this.classToWatch)
                        if(this.lastClassState !== currentClassState) {
                            this.lastClassState = currentClassState
                            if(currentClassState) {
                                this.classAddedCallback()
                            }
                            else {
                                this.classRemovedCallback()
                            }
                        }
                    }
                }
            }
            } 


            function trigger_result_wait () {
            let iframe =  document.getElementById('ookla').contentWindow

            // let results_div = document.getElementsByClassName('test test--init')[0];
            let results_div = iframe.document.querySelector("#root > div > div.test.test--init");

            console.log("results div is " + results_div);

            // watch for a specific class change
            let classWatcher = new ClassWatcher(results_div, 'test test--finished test--in-progress', workOnClassAdd, workOnClassRemoval)

            }


            function workOnClassAdd() {
            let iframe =  document.getElementById('ookla').contentWindow.document
            console.log("speed test just finished - extracting results now");
            let metrics = iframe.getElementsByClassName("number monochrome-primary");
            // let download_div = document.getElementById('sc-results-download');
            let download_speed = metrics[2];
            console.log("download speed is " + download_speed + " Mbps");

            // let upload_div = document.getElementById('sc-results-upload');
            let upload_speed = metrics[3];
            console.log("upload speed is " + upload_speed + " Mbps");
            }

            function workOnClassRemoval() {
            alert("I'm triggered when the class is removed");
            }


            window.addEventListener('load', function() {
            trigger_result_wait();
            });
    </script>
  
</body>
</html>