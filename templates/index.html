<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"">

  <title>Speedtest test</title>

</head>

<body>
    <h1>hi</h1>
    <div id="sc-container">
        <div id="sc-branding" class="sc-bb">
            <a target="_blank" href="https://www.speedcheck.org/">
                <img src="https://cdn.speedcheck.org/branding/speedcheck-logo-18.png" alt="Speedcheck"/>
            </a>
        </div>
    </div>
    <script>
        class ClassWatcher {

            constructor(targetNode, classToWatch, classAddedCallback, classRemovedCallback) {
                this.targetNode = targetNode
                this.classToWatch = classToWatch
                this.classAddedCallback = classAddedCallback
                this.classRemovedCallback = classRemovedCallback
                this.observer = null
                this.lastClassState = targetNode.classList.contains(this.classToWatch)

                this.init()
            }

            init() {
                this.observer = new MutationObserver(this.mutationCallback)
                this.observe()
            }

            observe() {
                this.observer.observe(this.targetNode, { attributes: true })
            }

            disconnect() {
                this.observer.disconnect()
            }

            mutationCallback = mutationsList => {
                for(let mutation of mutationsList) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        let currentClassState = mutation.target.classList.contains(this.classToWatch)
                        if(this.lastClassState !== currentClassState) {
                            this.lastClassState = currentClassState
                            if(currentClassState) {
                                this.classAddedCallback()
                            }
                            else {
                                this.classRemovedCallback()
                            }
                        }
                    }
                }
            }
        } 


        function trigger_result_wait () {
            // let speedcheck_div = document.getElementById('sc-container');
            let results_div = document.getElementById('sc-results');
            
            console.log(results_div);

            // watch for a specific class change
            let classWatcher = new ClassWatcher(results_div, 'sc-is-shown', workOnClassAdd, workOnClassRemoval)

        }
        

        function workOnClassAdd() {
            console.log("speed test just finished - extracting results now");
            let download_div = document.getElementById('sc-results-download');
            let download_speed = download_div.getElementsByClassName('sc-value')[0].textContent;
            console.log("download speed is " + download_speed + " Mbps");

            let upload_div = document.getElementById('sc-results-upload');
            let upload_speed = upload_div.getElementsByClassName('sc-value')[0].textContent;
            console.log("upload speed is " + upload_speed + " Mbps");
        }

        function workOnClassRemoval() {
            alert("I'm triggered when the class is removed");
        }

        
        window.addEventListener('load', function() {
        trigger_result_wait();
    });
        </script>
    <script src="https://cdn.speedcheck.org/basic/scbjs.min.js"></script>
  
</body>
</html>